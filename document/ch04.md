# ğŸ¤ node.jsì˜ express í”„ë ˆì„ì›Œí¬ ì´ìš©í•´ë³´ê¸° - express-session ì‚¬ìš©

---
- express-sessionì€ Express í”„ë ˆì„ì›Œí¬ì—ì„œ sessionì„ ê´€ë¦¬í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ë¯¸ë“¤ì›¨ì–´ì´ë‹¤.
- express-sessionì„ í†µí•´ ë¡œê·¸ì¸ ë° ë¡œê·¸ì•„ì›ƒì„ êµ¬í˜„í•´ë³¸ë‹¤.
---

## Use Example

#### Expressì— ì ìš©
```js
var session = require('express-session');

app.use(session({
 secret: '@#@$MYSIGN#@$#$',
 resave: false,
 saveUninitialized: true
}));
```
- secret : ì¿ í‚¤ë¥¼ ì„ì˜ë¡œ ë³€ì¡°í•˜ëŠ”ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ê°’ì´ë‹¤. ì´ ê°’ì„ í†µí•˜ì—¬ ì„¸ì…˜ì„ ì•”í˜¸í™” í•˜ì—¬ ì €ì¥í•œë‹¤.
- resave : ì„¸ì…˜ì„ ì–¸ì œë‚˜ ì €ì¥í•  ì§€ (ë³€ê²½ë˜ì§€ ì•Šì•„ë„) ì •í•˜ëŠ” ê°’ì´ë‹¤. express-session documentì—ì„œëŠ” ì´ ê°’ì„ false ë¡œ í•˜ëŠ”ê²ƒì„ ê¶Œì¥í•˜ê³  í•„ìš”ì— ë”°ë¼ trueë¡œ ì„¤ì •í•œë‹¤.
- saveUninitialized : ì„¸ì…˜ì´ ì €ì¥ë˜ê¸° ì „ì— uninitialized ìƒíƒœë¡œ ë¯¸ë¦¬ ë§Œë“¤ì–´ì„œ ì €ì¥í•œë‹¤.

#### Session Initialiaztion
```js
app.get('/', function(req, res){
    sess = req.session;
});
```
- ì´ë ‡ê²Œ ê°„ë‹¨í•˜ê²Œ router ì½œë°± í•¨ìˆ˜ ì•ˆì—ì„œ req.sessionìœ¼ë¡œ sessionì— ì ‘ê·¼ í•  ìˆ˜ ìˆë‹¤.

#### Use Session Veriable
```js
app.get('/', function(req, res){
    sess = req.session;
    console.log(sess.username);
});
```

#### Remove Session
```js
req.session.destroy(function(err){
   // cannot access session here
});
```
- sessionì„ ì œê±°í• ë•Œ(ë¡œê·¸ì•„ì›ƒ) ìœ„ì™€ ê°™ì´ í•œë‹¤.
- destory() ë©”ì†Œë“œì˜ ì½œë°± í•¨ìˆ˜ì—ì„œëŠ” ì„¸ì…˜ì— ì ‘ê·¼ í•  ìˆ˜ ì—†ë‹¤.

## Start
#### Login API
> íŒŒì¼ ìœ„ì¹˜ : router/main.js

```js
app.get('/login/:username/:password', function(req, res){
        var sess;
        sess = req.session;

        fs.readFile(__dirname + "/../data/user.json", "utf8", function(err, data){
            var users = JSON.parse(data);
            var username = req.params.username;
            var password = req.params.password;
            var result = {};
            if(!users[username]){
                // USERNAME NOT FOUND
                result["success"] = 0;
                result["error"] = "not found";
                res.json(result);
                return;
            }

            if(users[username]["password"] == password){
                result["success"] = 1;
                sess.username = username;
                sess.name = users[username]["name"];
                res.json(result);

            }else{
                result["success"] = 0;
                result["error"] = "incorrect";
                res.json(result);
            }
        })
    });
```
- ë¡œê·¸ì¸ì— ì„±ê³µí–ˆë‹¤ë©´ sessionì— usernameê³¼ nameì„ ì €ì¥í•œë‹¤.

#### Logout API
```js
    app.get('/logout', function(req, res){
        sess = req.session;
        if(sess.username){
            req.session.destroy(function(err){
                if(err){
                    console.log(err);
                }else{
                    res.redirect('/');
                }
            })
        }else{
            res.redirect('/');
        }
    })
```
- ë¡œê·¸ì•„ì›ƒì„ í•˜ë©´ ë©”ì¸ í˜ì´ì§€ë¡œ redirectë©ë‹ˆë‹¤.

#### main page ìˆ˜ì •
```js
    app.get('/',function(req,res){
         var sess = req.session;


         res.render('index', {
             title: "MY HOMEPAGE",
             length: 5,
             name: sess.name,
             username: sess.username
         })
     });
```
- ë©”ì¸ í˜ì´ì§€ì—ì„œ sessionì„ ì¡°íšŒ í•  ìˆ˜ ìˆë„ë¡ ìˆ˜ì •í•œë‹¤.
- ejs í…œí”Œë¦¿ ì—”ì§„ì— ì „ë‹¬í•˜ê²Œ ë§Œë“¤ì—ˆê³  ejs ì—ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ ì˜¬ ìˆ˜ ìˆë‹¤.

#### body.ejs ìˆ˜ì •
```html
<h1>Loop it!</h1>
<ul>
    <% for(var i=0; i<length; i++){ %>
        <li>
            <%= "LOOP" + i %>
        </li>
    <% } %>
</ul>

<% if(username){ %>
    <h2>Welcome! <%= username %> (name: <%= name %>)</h2>
<% }else{ %>
    <h2> Please Login. </h2>
<% } %>
```
- ë¡œê·¸ì¸ì— ì„±ê³µí–ˆë‹¤ë©´ í™˜ì˜ ë©”ì‹œì§€ê°€ ë‚˜ì˜¤ê³  ì•„ë‹ˆë©´ ë¡œê·¸ì¸í•˜ë¼ê³  ë‚˜ì˜¨ë‹¤.

## Final

1. `localhost:3000`ì— ì ‘ì†í•œë‹¤.

![main](../image/ch04/main.png)

2. ë¡œê·¸ì¸ì„ ìœ„í•´ ë¡œê·¸ì¸ APIì¸ `/login/username/password`ë¥¼ ì…ë ¥í•œë‹¤. ( ì£¼ì˜ ! ìœ ì €ì •ë³´ëŠ” `data/user.json`ì— ì…ë ¥ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤.)

![login](../image/ch04/login.png)

3. ë¡œê·¸ì¸ ë˜ì—ˆëŠ”ì§€ main í˜ì´ì§€ì—ì„œ í™•ì¸í•œë‹¤.

![session](../image/ch04/session.png)

4. `localhost:3000/logout`ì„ ì…ë ¥í•˜ì—¬ logout APIë¥¼ ì‹¤í–‰í•œë‹¤. 


![main](../image/ch04/main.png)

- main pageë¡œ redirect ë˜ê¸° ë•Œë¬¸ì— ë°”ë¡œ ì´ˆê¸°í™”ë©´ìœ¼ë¡œ ëŒì•„ì˜¨ë‹¤.